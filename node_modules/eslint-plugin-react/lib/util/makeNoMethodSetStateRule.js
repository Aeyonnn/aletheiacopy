/**
 * @fileoverview Prevent usage of setState in lifecycle methods
 * @author Yannick Croissant
 */
<<<<<<< HEAD
'use strict';

const docsUrl = require('./docsUrl');
=======

'use strict';

const docsUrl = require('./docsUrl');
const report = require('./report');
>>>>>>> d9d57759386cbc64761f26a577729c9da898f4b0

// ------------------------------------------------------------------------------
// Rule Definition
// ------------------------------------------------------------------------------

<<<<<<< HEAD
=======
function mapTitle(methodName) {
  const map = {
    componentDidMount: 'did-mount',
    componentDidUpdate: 'did-update',
    componentWillUpdate: 'will-update',
  };
  const title = map[methodName];
  if (!title) {
    throw Error(`No docsUrl for '${methodName}'`);
  }
  return `no-${title}-set-state`;
}

const messages = {
  noSetState: 'Do not use setState in {{name}}',
};

>>>>>>> d9d57759386cbc64761f26a577729c9da898f4b0
function makeNoMethodSetStateRule(methodName, shouldCheckUnsafeCb) {
  return {
    meta: {
      docs: {
        description: `Prevent usage of setState in ${methodName}`,
        category: 'Best Practices',
        recommended: false,
<<<<<<< HEAD
        url: docsUrl(methodName)
      },

      schema: [{
        enum: ['disallow-in-func']
      }]
    },

    create: function(context) {
=======
        url: docsUrl(mapTitle(methodName)),
      },

      messages,

      schema: [{
        enum: ['disallow-in-func'],
      }],
    },

    create(context) {
>>>>>>> d9d57759386cbc64761f26a577729c9da898f4b0
      const mode = context.options[0] || 'allow-in-func';

      function nameMatches(name) {
        if (name === methodName) {
          return true;
        }

        if (typeof shouldCheckUnsafeCb === 'function' && shouldCheckUnsafeCb(context)) {
          return name === `UNSAFE_${methodName}`;
        }

        return false;
      }

      // --------------------------------------------------------------------------
      // Public
      // --------------------------------------------------------------------------

      return {

<<<<<<< HEAD
        CallExpression: function(node) {
          const callee = node.callee;
          if (
            callee.type !== 'MemberExpression' ||
            callee.object.type !== 'ThisExpression' ||
            callee.property.name !== 'setState'
=======
        CallExpression(node) {
          const callee = node.callee;
          if (
            callee.type !== 'MemberExpression'
            || callee.object.type !== 'ThisExpression'
            || callee.property.name !== 'setState'
>>>>>>> d9d57759386cbc64761f26a577729c9da898f4b0
          ) {
            return;
          }
          const ancestors = context.getAncestors(callee).reverse();
          let depth = 0;
<<<<<<< HEAD
          for (let i = 0, j = ancestors.length; i < j; i++) {
            const ancestor = ancestors[i];
=======
          ancestors.some((ancestor) => {
>>>>>>> d9d57759386cbc64761f26a577729c9da898f4b0
            if (/Function(Expression|Declaration)$/.test(ancestor.type)) {
              depth++;
            }
            if (
<<<<<<< HEAD
              (ancestor.type !== 'Property' && ancestor.type !== 'MethodDefinition') ||
              !nameMatches(ancestor.key.name) ||
              (mode !== 'disallow-in-func' && depth > 1)
            ) {
              continue;
            }
            context.report({
              node: callee,
              message: `Do not use setState in ${ancestor.key.name}`
            });
            break;
          }
        }
      };
    }
=======
              (ancestor.type !== 'Property' && ancestor.type !== 'MethodDefinition' && ancestor.type !== 'ClassProperty' && ancestor.type !== 'PropertyDefinition')
              || !nameMatches(ancestor.key.name)
              || (mode !== 'disallow-in-func' && depth > 1)
            ) {
              return false;
            }
            report(context, messages.noSetState, 'noSetState', {
              node: callee,
              data: {
                name: ancestor.key.name,
              },
            });
            return true;
          });
        },
      };
    },
>>>>>>> d9d57759386cbc64761f26a577729c9da898f4b0
  };
}

module.exports = makeNoMethodSetStateRule;
